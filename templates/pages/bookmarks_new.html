{% extends "layout/main.html" %}

{% block title %}Add Bookmark - PagePouch{% endblock title %}

{% block content %}
  <main>
    <section>
      <form hx-post="/bookmarks" hx-target="body" hx-swap="transition:true">
        <div class="form-group">
          <label for="url">URL *</label>
          <input
            type="url"
            id="url"
            name="url"
            required
            placeholder="https://example.com/article"
            autofocus
          />
        </div>

        <div class="form-group">
          <label for="title">Title *</label>
          <input
            type="text"
            id="title"
            name="title"
            required
            placeholder="Article title will be fetched automatically..."
          />
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            name="description"
            rows="3"
            placeholder="Optional description or notes..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="tags">Tags</label>
          <input
            type="text"
            id="tags"
            name="tags"
            placeholder="programming, rust, web-dev (comma separated)"
          />
        </div>

        <div class="form-actions">
          <button type="submit">Save</button>
          <a
            href="/"
            role="button"
            class="secondary"
            hx-get="/"
            hx-target="body"
            >Cancel</a
          >
        </div>
      </form>

      <div id="form-result"></div>
    </section>
  </main>

  <script>
    document.addEventListener("keydown", function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        const form = document.querySelector("form");
        if (form) {
          form.dispatchEvent(
            new Event("submit", { bubbles: true, cancelable: true }),
          );
        }
      }
    });

    // Auto-fetch title and description when URL field loses focus
    document.getElementById("url").addEventListener("blur", async function (e) {
      const url = e.target.value.trim();

      // Don't make request for empty or very short URLs
      if (url.length < 3) {
        return;
      }

      const titleField = document.getElementById("title");
      const descriptionField = document.getElementById("description");

      try {
        const response = await fetch("/api/fetch-title", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({ url: url }),
        });

        if (response.ok) {
          const data = await response.json();

          // Update title field if we got a scraped title
          if (data.title) {
            titleField.value = data.title;
          }

          // Update description field if we got one
          if (data.description) {
            descriptionField.value = data.description;
          }

          // Update URL field if it was corrected (e.g., protocol added)
          if (data.corrected_url && data.corrected_url !== url) {
            e.target.value = data.corrected_url;
          }
        }
      } catch (error) {
        // ignore
      }
    });
  </script>
{% endblock content %}
